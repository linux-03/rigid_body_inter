name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.3'
      - name: Install the dependencies
        run: |
          python -m pip install -r requirements.txt
        
      - name: Prepare local pypi (copy wheel(s) into files/pypi)
        run: |
          set -eux
          echo "repo ./pypi_test contents:"
          ls -la ./pypi_test || true

          mkdir -p files/pypi
          # copy wheel(s) - fail if none
          shopt -s nullglob
          WHLS=(./pypi_test/*.whl)
          if [ ${#WHLS[@]} -eq 0 ]; then
            echo "ERROR: no wheels found in ./pypi_test; list ./pypi_test above"
            exit 1
          fi
          cp -v ./pypi_test/*.whl files/pypi/
          echo "files/pypi after copy:"
          ls -la files/pypi
      
      - name: Create pip index for JupyterLite (ensure jupyterlite-core present)
        run: |
          set -eux
          python --version
          python -m pip --version

          # ensure jupyter lite pip index CLI is available
          python -m pip show jupyterlite-core || python -m pip install jupyterlite-core
          python -m pip show jupyterlite-piplite || python -m pip install jupyterlite-piplite

          echo "running: python -m jupyter lite pip index files/pypi"
          # run the index command and capture output
          python -m jupyter lite pip index files/pypi 2>&1 | tee /tmp/jl_pip_index.log || ( echo "index failed; show log:"; sed -n '1,200p' /tmp/jl_pip_index.log; exit 1 )

          echo "files/pypi contains:"
          ls -la files/pypi || true

          echo "HEAD of files/pypi/index.json (if present):"
          head -n 80 files/pypi/index.json || true
        
      - name: Build the JupyterLite site (invoke via python -m)
        run: |
          set -eux
          # fail early if index.json absent (safety)
          if [ ! -f files/pypi/index.json ]; then
            echo "ERROR: files/pypi/index.json missing; aborting build"
            ls -la files || true
            ls -la files/pypi || true
            exit 1
          fi

          # include 'files' in the site so the wheel and index are deployed to dist/files/pypi
          TZ=UTC python -m jupyter lite build --contents files --output-dir ./dist \
            --pyodide https://ngsolve.org/files/pyodide-0.26.0/ngsolve_pyodide.tar.bz2 2>&1 | tee /tmp/jupyter_lite_build.log

          echo "DIST listing:"
          ls -la dist || true
          echo "DIST files/pypi listing:"
          ls -la dist/files/pypi || true
          test -f dist/index.html
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./dist

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4